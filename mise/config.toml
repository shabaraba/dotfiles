# mise global configuration
# Managed by dotfiles repository
#
# This file is deployed to ~/.config/mise/config.toml
# Tasks defined here are available from any directory

[settings]
# Enable idiomatic version files for common tools
# This allows mise to read .node-version, .python-version, etc. in other projects
idiomatic_version_file_enable_tools = ["node", "python", "ruby", "go", "java"]

# =============================================================================
# Global Tasks (available from anywhere)
# =============================================================================

[tasks.deploy]
description = "Deploy dotfiles symlinks to home directory"
run = "sh deployer.sh"
dir = "~/dotfiles"

[tasks."dotfiles:update"]
description = "Update dotfiles from git and redeploy"
run = """
git pull origin main
sh deployer.sh
"""
dir = "~/dotfiles"

[tasks."dotfiles:status"]
description = "Show git status of dotfiles"
run = "git status"
dir = "~/dotfiles"

[tasks."brew:update"]
description = "Update Homebrew and all packages"
run = """
brew update
brew upgrade
brew cleanup
"""

[tasks."brew:dump"]
description = "Update Brewfile with currently installed packages"
run = "brew bundle dump --force --describe --file=installers/Brewfile"
dir = "~/dotfiles"

[tasks."brew:check"]
description = "Check if all Brewfile packages are installed"
run = "brew bundle check --file=installers/Brewfile"
dir = "~/dotfiles"

[tasks."cache:clean"]
description = "Clean system caches"
run = """
echo "Cleaning Homebrew cache..."
brew cleanup -s
echo "Cleaning npm cache..."
npm cache clean --force 2>/dev/null || true
echo "Cleaning Python cache..."
find . -type d -name '__pycache__' -exec rm -rf {} + 2>/dev/null || true
echo "Done!"
"""

[tasks.myip]
description = "Show my public IP address"
run = "curl -s ifconfig.me && echo"

[tasks.ports]
description = "List all listening ports"
run = "lsof -i -P | grep LISTEN"

[tasks."dns:flush"]
description = "Flush DNS cache (macOS)"
run = """
sudo dscacheutil -flushcache
sudo killall -HUP mDNSResponder
echo "DNS cache flushed"
"""

[tasks."git:cleanup"]
description = "Clean up merged git branches"
run = """
echo "Deleting merged branches..."
git branch --merged | grep -v '\\*\\|main\\|master\\|develop' | xargs -n 1 git branch -d
echo "Done!"
"""

[tasks.sysinfo]
description = "Show system information"
run = """
echo "=== System Info ==="
echo "OS: $(uname -s) $(uname -r)"
echo "Node: $(node -v 2>/dev/null || echo 'not installed')"
echo "Python: $(python --version 2>/dev/null || echo 'not installed')"
echo "mise: $(mise --version)"
echo "Homebrew: $(brew --version | head -n 1)"
"""

# =============================================================================
# GitHub Repository Setup Tasks
# =============================================================================

[tasks."gh:repo-init"]
description = "Initialize repository with release-please and branch protection"
run = "bash \"$HOME/dotfiles/mise/scripts/gh-repo-init.sh\" \"$@\""

[tasks."gh:repo-init:workflow"]
description = "Create release-please workflow file only"
run = "bash \"$HOME/dotfiles/mise/scripts/gh-repo-init-workflow.sh\""

[tasks."gh:repo-init:config"]
description = "Create release-please config files only"
run = "bash \"$HOME/dotfiles/mise/scripts/gh-repo-init-config.sh\" \"$@\""

[tasks."gh:repo-init:hook"]
description = "Setup pre-commit hook to prevent commits to main"
run = "bash \"$HOME/dotfiles/mise/scripts/gh-repo-init-hook.sh\""

[tasks."gh:repo-init:protect"]
description = "Setup GitHub repository protection settings"
run = "bash \"$HOME/dotfiles/mise/scripts/gh-repo-init-protect.sh\""
